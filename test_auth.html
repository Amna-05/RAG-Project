<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê RAG Auth Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow);
            border: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--primary);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.875rem;
            color: var(--text-dim);
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--surface-light);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        .result.show {
            display: block;
        }

        .result.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .result.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .result.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #60a5fa;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 12px;
        }

        .status-indicator.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-indicator.offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cookie-list {
            background: var(--bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .cookie-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cookie-item:last-child {
            border-bottom: none;
        }

        .cookie-name {
            font-weight: 600;
            color: var(--primary);
        }

        .cookie-value {
            color: var(--text-dim);
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.875rem;
            color: #60a5fa;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-dim);
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 3rem;
            }

            .btn-group {
                flex-wrap: nowrap;
            }
        }

        @media (max-width: 767px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.75rem;
            }

            .card {
                padding: 16px;
            }

            button {
                min-width: 100%;
            }

            .btn-group {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .subtitle {
                font-size: 0.875rem;
            }

            input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê RAG Auth Tester</h1>
            <p class="subtitle">Test your cookie-based authentication system</p>
            <div class="status-indicator" id="api-status">
                <span class="pulse"></span>
                <span>Checking API...</span>
            </div>
        </header>

        <div class="grid">
            <!-- Register Card -->
            <div class="card">
                <h2>
                    <span>üìù</span> Register
                    <span class="badge">Step 1</span>
                </h2>
                <div class="input-group">
                    <label for="reg-email">Email</label>
                    <input type="email" id="reg-email" placeholder="user@example.com" value="test@example.com">
                </div>
                <div class="input-group">
                    <label for="reg-username">Username</label>
                    <input type="text" id="reg-username" placeholder="username" value="testuser">
                </div>
                <div class="input-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="SecurePass123">
                </div>
                <div class="input-group">
                    <label for="reg-fullname">Full Name</label>
                    <input type="text" id="reg-fullname" placeholder="John Doe" value="Test User">
                </div>
                <div class="btn-group">
                    <button onclick="register()" id="reg-btn">
                        Register & Auto-Login
                    </button>
                </div>
                <div id="reg-result" class="result"></div>
            </div>

            <!-- Login Card -->
            <div class="card">
                <h2>
                    <span>üîë</span> Login
                    <span class="badge">Step 2</span>
                </h2>
                <div class="input-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="user@example.com" value="test@example.com">
                </div>
                <div class="input-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="SecurePass123">
                </div>
                <div class="btn-group">
                    <button onclick="login()" id="login-btn">
                        Login
                    </button>
                </div>
                <div id="login-result" class="result"></div>
            </div>

            <!-- Profile Card -->
            <div class="card">
                <h2>
                    <span>üë§</span> My Profile
                    <span class="badge">Protected</span>
                </h2>
                <div class="info-box">
                    This endpoint requires authentication. Cookies are sent automatically!
                </div>
                <div class="btn-group">
                    <button onclick="getProfile()" id="profile-btn">
                        Get My Profile
                    </button>
                    <button onclick="checkAuth()" class="btn-secondary">
                        Check Auth Status
                    </button>
                </div>
                <div id="profile-result" class="result"></div>
            </div>

            <!-- Cookies Card -->
            <div class="card">
                <h2>
                    <span>üç™</span> Cookies
                    <span class="badge">Debug</span>
                </h2>
                <div class="info-box">
                    HttpOnly cookies won't appear here (security feature). Check DevTools ‚Üí Application ‚Üí Cookies.
                </div>
                <div class="btn-group">
                    <button onclick="checkCookies()" class="btn-secondary">
                        Check Cookies
                    </button>
                    <button onclick="openDevTools()" class="btn-secondary">
                        Open DevTools Guide
                    </button>
                </div>
                <div id="cookie-result" class="result"></div>
            </div>

            <!-- Refresh Token Card -->
            <div class="card">
                <h2>
                    <span>üîÑ</span> Refresh Token
                    <span class="badge">Auto</span>
                </h2>
                <div class="info-box">
                    Refresh your access token without re-entering password.
                </div>
                <div class="btn-group">
                    <button onclick="refreshToken()" class="btn-secondary">
                        Refresh Token
                    </button>
                </div>
                <div id="refresh-result" class="result"></div>
            </div>

            <!-- Logout Card -->
            <div class="card">
                <h2>
                    <span>üö™</span> Logout
                    <span class="badge">Action</span>
                </h2>
                <div class="info-box">
                    Clear cookies and revoke refresh token.
                </div>
                <div class="btn-group">
                    <button onclick="logout()" class="btn-danger">
                        Logout
                    </button>
                    <button onclick="logoutAll()" class="btn-danger">
                        Logout All Sessions
                    </button>
                </div>
                <div id="logout-result" class="result"></div>
            </div>
        </div>

        <footer>
            <p>üí° Tip: Open DevTools (F12) ‚Üí Application ‚Üí Cookies to see HttpOnly cookies</p>
            <p style="margin-top: 8px; opacity: 0.7;">Built with ‚ù§Ô∏è for testing RAG Auth System</p>
        </footer>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/v1';

        // Check API status on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('http://127.0.0.1:8000/health');
                const statusEl = document.getElementById('api-status');
                if (response.ok) {
                    statusEl.className = 'status-indicator online';
                    statusEl.innerHTML = '<span class="pulse"></span><span>API Online</span>';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                const statusEl = document.getElementById('api-status');
                statusEl.className = 'status-indicator offline';
                statusEl.innerHTML = '<span class="pulse"></span><span>API Offline</span>';
            }
        });

        function showResult(elementId, message, type = 'success') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `result show ${type}`;
        }

        function setLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML += '<span class="loading"></span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.innerHTML.replace(/<span class="loading"><\/span>/, '');
            }
        }

        async function register() {
            setLoading('reg-btn', true);
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: document.getElementById('reg-email').value,
                        username: document.getElementById('reg-username').value,
                        password: document.getElementById('reg-password').value,
                        full_name: document.getElementById('reg-fullname').value
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('reg-result', 
                        `‚úÖ Registration successful!\n\nUser ID: ${data.id}\nUsername: ${data.username}\nEmail: ${data.email}\n\nüç™ Cookies automatically set!`,
                        'success'
                    );
                } else {
                    showResult('reg-result', 
                        `‚ùå Registration failed!\n\nError: ${data.detail || JSON.stringify(data)}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('reg-result', `‚ùå Network error: ${error.message}`, 'error');
            } finally {
                setLoading('reg-btn', false);
            }
        }

        async function login() {
            setLoading('login-btn', true);
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: document.getElementById('login-email').value,
                        password: document.getElementById('login-password').value
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('login-result', 
                        `‚úÖ Login successful!\n\nWelcome, ${data.username}!\nEmail: ${data.email}\n\nüç™ Auth cookies updated!`,
                        'success'
                    );
                } else {
                    showResult('login-result', 
                        `‚ùå Login failed!\n\nError: ${data.detail || 'Invalid credentials'}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('login-result', `‚ùå Network error: ${error.message}`, 'error');
            } finally {
                setLoading('login-btn', false);
            }
        }

        async function getProfile() {
            setLoading('profile-btn', true);
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Not authenticated`);
                }
                
                const data = await response.json();
                showResult('profile-result', 
                    `‚úÖ Profile loaded!\n\n${JSON.stringify(data, null, 2)}\n\nüîí Authenticated via cookies!`,
                    'success'
                );
            } catch (error) {
                showResult('profile-result', 
                    `‚ùå ${error.message}\n\nPlease login first!`,
                    'error'
                );
            } finally {
                setLoading('profile-btn', false);
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/check`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.authenticated) {
                    showResult('profile-result', 
                        `‚úÖ Authenticated!\n\n${JSON.stringify(data.user, null, 2)}`,
                        'success'
                    );
                } else {
                    showResult('profile-result', 
                        `‚ÑπÔ∏è Not authenticated\n\nPlease login to continue.`,
                        'info'
                    );
                }
            } catch (error) {
                showResult('profile-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        function checkCookies() {
            const cookies = document.cookie;
            const resultEl = document.getElementById('cookie-result');
            
            if (cookies) {
                showResult('cookie-result', 
                    `üìã Visible Cookies:\n\n${cookies}\n\n‚ÑπÔ∏è HttpOnly cookies (access_token, refresh_token) are hidden from JavaScript.`,
                    'info'
                );
            } else {
                showResult('cookie-result', 
                    `‚ÑπÔ∏è No JavaScript-accessible cookies found.\n\nThis is CORRECT! HttpOnly cookies are hidden for security.\n\nüí° Check DevTools ‚Üí Application ‚Üí Cookies`,
                    'info'
                );
            }
        }

        function openDevTools() {
            showResult('cookie-result', 
                `üìñ How to View Cookies:\n\n1. Press F12 (or Cmd+Option+I on Mac)\n2. Click "Application" tab\n3. Expand "Cookies" in left sidebar\n4. Click "http://127.0.0.1:8000"\n5. See access_token and refresh_token!\n\n‚ú® Try it now!`,
                'info'
            );
        }

        async function refreshToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('refresh-result', 
                        `‚úÖ Token refreshed!\n\n${data.message}\n\nüîÑ New access_token set in cookies!`,
                        'success'
                    );
                } else {
                    showResult('refresh-result', 
                        `‚ùå Refresh failed!\n\n${data.detail}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('refresh-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('logout-result', 
                        `‚úÖ Logged out successfully!\n\nüç™ Cookies cleared!\n\n${data.message}`,
                        'success'
                    );
                } else {
                    showResult('logout-result', 
                        `‚ùå Logout failed!\n\n${data.detail}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('logout-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function logoutAll() {
            if (!confirm('Logout from ALL devices? This will revoke all active sessions.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/logout-all`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('logout-result', 
                        `‚úÖ ${data.message}\n\nüîí All sessions terminated!`,
                        'success'
                    );
                } else {
                    showResult('logout-result', 
                        `‚ùå Failed!\n\n${data.detail}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('logout-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>